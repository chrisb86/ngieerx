# config file for @@nginx_domains@@
# php-fpm port @@php_pool_port@@

server {
  listen [::]:80;
  listen 80;

  server_name @@nginx_domains@@;

  ## letsencrypt authentication
  location '/.well-known/acme-challenge' {
    default_type "text/plain";
    alias @@letsencrypt_webroot@@;
  }

  ## force ssl
  location / {
    return 301 https://$server_name$request_uri;
  }
}

server {
  # Ports and protocols
  listen [::]:443 ssl http2;
  listen 443 ssl http2;

  # Domain names
  server_name @@nginx_domains@@;
  
  # SSL settings
  ssl_certificate @@site_root@@/certs/fullchain.pem;
  ssl_certificate_key @@site_root@@/certs/privkey.pem;
  ssl_trusted_certificate @@site_root@@/certs/fullchain.pem;
  ssl_dhparam @@nginx_conf_dir@@/dhparam.pem;

  # log files
  access_log @@site_root@@/log/nginx.access.log main;
  error_log @@site_root@@/log/nginx.error.log crit;

  root @@site_webroot@@/owncloud;

  # set max upload size
  client_max_body_size 10G;
  fastcgi_buffers 64 4K;

  # Disable gzip to avoid the removal of the ETag header
  gzip off;

  # Uncomment if your server is build with the ngx_pagespeed module
  # This module is currently not supported.
  #pagespeed off;

  rewrite ^/caldav(.*)$ /remote.php/caldav$1 redirect;
  rewrite ^/carddav(.*)$ /remote.php/carddav$1 redirect;
  rewrite ^/webdav(.*)$ /remote.php/webdav$1 redirect;

  error_page 403 /core/templates/403.php;
  error_page 404 /core/templates/404.php;

  location = /robots.txt {
    allow all;
    log_not_found off;
    access_log off;
  }

  location ~ ^/(?:\.htaccess|data|config|db_structure\.xml|README){
    deny all;
  }

  location / {
    # The following 2 rules are only needed with webfinger
    rewrite ^/.well-known/host-meta /public.php?service=host-meta last;
    rewrite ^/.well-known/host-meta.json /public.php?service=host-meta-json last;

    rewrite ^/.well-known/carddav /remote.php/carddav/ redirect;
    rewrite ^/.well-known/caldav /remote.php/caldav/ redirect;

    rewrite ^(/core/doc/[^\/]+/)$ $1/index.html;

    try_files $uri $uri/ /index.php;
  }

  # PHP handler (is configured in @@phpfpm_conf_dir@@/@@site_domain@@.conf)
  location ~ \.php(?:$|/) {
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO $fastcgi_path_info;
    fastcgi_param HTTPS on;
    fastcgi_pass @@server_ip@@:@@php_pool_port@@;
  }

  # Adding the cache control header for js and css files
  # Make sure it is BELOW the location ~ \.php(?:$|/) { block
  location ~* \.(?:css|js)$ {
    add_header Cache-Control "public, max-age=7200";
    # Add headers to serve security related headers
    add_header Strict-Transport-Security "max-age=15768000; includeSubDomains; preload;";
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Robots-Tag none;
    # Optional: Don't log access to assets
    access_log off;
  }

  # Optional: Don't log access to other assets
  location ~* \.(?:jpg|jpeg|gif|bmp|ico|png|swf)$ {
    access_log off;
  }
}